#!/usr/bin/env bash
#
#
set -u -e -o pipefail

# Examples:
#   da www --help
#   da www serve static
#
#   da public_files --help
#   da public_files manifest
#
#   da string color red ...
#   da new fish function ...
#   da new .rb|ruby ...
#   da new .sh|bash ...
#
#   da --help|help www
DA_BIN="$(dirname "$0")"
DA_DIR="$(dirname "$DA_BIN")"
DA_NAME="$(basename "$0")"
MAIN_CMD="$1"
DA_CMD="$DA_NAME $MAIN_CMD"

case "$1" in
  "-h"|"--help"|"help")
    shift
    if ! test -z "$*" ; then
      $DA_CMD | grep "$*"
      exit 0
    fi
    echo "$DA_NAME -h|--help|help -- Show this message."
    cd "$DA_DIR"/src
    while read -r raw_thing ; do
      thing="$(basename "$raw_thing")"
      if test -f "$raw_thing" || { test -d "$thing" && test -e "$thing"/main; }  then
        intro_line="$("$DA_NAME" "$thing" help intro line 2>/dev/null || : )"
        if test -n "$intro_line" ; then
          echo "$DA_NAME" "$(da string bold "$thing")" "$intro_line"
        else
          echo "$DA_NAME $thing"
        fi
      fi
    done < <(find . -maxdepth 1 -mindepth 1 | sort)
    ;;

  *)
    export DA_BIN;
    export DA_DIR;
    export DA_CMD;
    export MAIN_CMD;
    shift

    AS_FILE="$DA_DIR/src/$MAIN_CMD"
    if test -f "$AS_FILE" ; then
      exec "$AS_FILE" "$@"
    fi

    AS_MAIN="$DA_DIR/src/$MAIN_CMD/main"
    if test -f "$AS_MAIN" ; then
      exec "$AS_MAIN" "$@"
    fi

    AS_APP="/apps/$MAIN_CMD/bin/$MAIN_CMD"
    if test -f "$AS_APP" ; then
      exec "$AS_APP" "$@"
    fi

    echo "!!! Unknown command: $*" >&2
    exit 1
    ;;
esac
